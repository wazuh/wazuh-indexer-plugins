---
"Test update endpoint returns 404 when no subscription exists":
  - do:
      catch: missing  # Expects 404 Not Found
      content_manager.update: {}

  - match: { status: 404 }
  - match: { message: "Subscription not found. Please create a subscription before attempting to update." }


---
"Test update endpoint returns 202 with valid subscription":
  - skip:
      features: headers
  # Create subscription first
  - do:
      headers:
        Content-Type: application/json
      content_manager_subscription_post:
        body: |
          {
            "device_code": "test-device-code",
            "client_id": "test-client-id",
            "expires_in": 3600,
            "interval": 5
          }

  - match: { status: 201 }
  - match: { message: "Subscription created successfully" }

  # Now trigger update
  - do:
      headers:
        Content-Type: application/json
      content_manager.update: {}

  - match: { status: "update accepted" }

  # Cleanup subscription
  - do:
      content_manager_subscription_delete: {}

  - match: { status: 200 }
  - match: { message: "Subscription deleted successfully" }

---
"Test update endpoint returns 429 when rate limit exceeded":
  - skip:
      features: headers
  # Create subscription first
  - do:
      headers:
        Content-Type: application/json
      content_manager_subscription_post:
        body: |
          {
            "device_code": "test-device-code",
            "client_id": "test-client-id",
            "expires_in": 3600,
            "interval": 5
          }

  - match: { status: 201 }
  - match: { message: "Subscription created successfully" }

  # First request - should succeed
  - do:
      headers:
        Content-Type: application/json
      content_manager.update: {}

  - match: { status: "update accepted" }

  # Second request - should succeed
  - do:
      headers:
        Content-Type: application/json
      content_manager.update: {}

  - match: { status: "update accepted" }

  # Third request - should fail with 429
  - do:
      catch: request
      headers:
        Content-Type: application/json
      content_manager.update: {}

  - match: { status: 429 }
  - match: { message: "Too many update requests. Please try again later." }

  # Cleanup subscription
  - do:
      content_manager_subscription_delete: {}

  - match: { status: 200 }
  - match: { message: "Subscription deleted successfully" }
