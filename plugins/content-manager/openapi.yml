openapi: 3.0.0
info:
  title: Indexer Content Manager API
  description: |
    API for content management and subscription handling for the Wazuh Indexer Content Manager.
    This API enables Cyber Threat Intelligence (CTI) subscription registration, credential management,
    and on-demand content updates for threat intelligence feeds.
  version: 1.0.0
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html
servers:
  - url: "{protocol}://{wazuh.indexer}:{port}/_plugins/content-manager"
    description: Wazuh Indexer Content Manager Plugin
    variables:
      protocol:
        enum:
          - "http"
          - "https"
        default: "https"
      wazuh.indexer:
        default: localhost
      port:
        default: "9200"

tags:
  - name: Subscription Management
    description: Operations for managing CTI subscriptions and credentials
  - name: Content Updates
    description: Operations for triggering content updates
  - name: KVDBs
    description: Manage key-value databases used by content
  - name: Decoders
    description: Manage decoders for parsing and normalization
  - name: Rules
    description: Manage detection rules and analytics
  - name: Integrations
    description: Manage integration metadata and related content
  - name: Logtest
    description: Execute logtest against sample events
  - name: Promotion
    description: Preview and promote content across spaces

security:
  - bearerAuth: []
  - basicAuth: []

paths:
  /subscription:
    description: CTI registration & CTI credentials retrieval
    post:
      summary: Register CTI Subscription
      description: |
        Register a new Cyber Threat Intelligence subscription using device code authentication flow.
        This endpoint initiates the subscription process and must be called with valid device code
        credentials obtained from the CTI provider. The registration process is asynchronous and
        may take several seconds to complete.
      operationId: registerSubscription
      tags:
        - Subscription Management
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/SubscriptionPostRequest"
            examples:
              registration:
                summary: Example subscription registration
                value:
                  device_code: "GmRhmhcxhwAzkoEqiMEg_DnyEysNkuNhszIySk9eS"
                  client_id: "a17c21ed"
                  expires_in: 1800
                  interval: 5
      responses:
        "201":
          $ref: "#/components/responses/SubscriptionCreated"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

    get:
      summary: Retrieve CTI Credentials
      description: |
        Retrieve the access token and credentials for an active CTI subscription.
        The access token should be used as a Bearer token for subsequent API calls to CTI services.
      operationId: getCredentials
      tags:
        - Subscription Management
      responses:
        "200":
          $ref: "#/components/responses/GetCredentialsSuccess"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      summary: Delete CTI Subscription
      description: |
        Delete an existing CTI subscription and revoke all associated credentials.
        This operation is irreversible and will immediately terminate access to threat intelligence feeds.
      operationId: deleteSubscription
      tags:
        - Subscription Management
      responses:
        "200":
          $ref: "#/components/responses/SubscriptionDeleted"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /update:
    description: On demand content update
    post:
      summary: Initiate On-Demand Content Update
      description: |
        Trigger an immediate update of threat intelligence content from subscribed CTI feeds.
        This operation is asynchronous and returns immediately with a task identifier.
        The update process runs in the background and may take several minutes to complete
        depending on the volume of new threat intelligence data.

        **Rate Limiting**: This endpoint is rate-limited to prevent excessive API calls.
        The default limit is 10 requests per hour.
      operationId: updateContent
      tags:
        - Content Updates
      responses:
        "202":
          $ref: "#/components/responses/UpdateAccepted"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          $ref: "#/components/responses/NotFound"
        "409":
          $ref: "#/components/responses/Conflict"
        "429":
          $ref: "#/components/responses/TooManyRequests"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # KVDB management endpoints
  /kvdbs:
    post:
      tags: [KVDBs]
      summary: Create KVDB
      description: |
        Creates a KVDB in the draft space. The server generates the UUID.
      operationId: createKvdb
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/KvdbResource"
      responses:
        "201":
          description: KVDB created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /kvdbs/{kvdb_id}:
    put:
      tags: [KVDBs]
      summary: Update KVDB
      operationId: updateKvdb
      parameters:
        - $ref: "#/components/parameters/KvdbId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/KvdbResource"
      responses:
        "200":
          description: KVDB updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [KVDBs]
      summary: Delete KVDB
      operationId: deleteKvdb
      parameters:
        - $ref: "#/components/parameters/KvdbId"
      responses:
        "200":
          $ref: "#/components/responses/ResourceDeleted"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Decoder management endpoints
  /decoders:
    post:
      tags: [Decoders]
      summary: Create Decoder
      description: |
        Creates a decoder in the draft space. The server generates the UUID for the decoder.
        The decoder is validated against the Wazuh engine before being stored.
        The decoder is automatically linked to the specified integration.
      operationId: createDecoder
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - type
                - integration
                - resource
              properties:
                type:
                  type: string
                  enum: [decoder]
                  example: decoder
                integration:
                  type: string
                  format: uuid
                  description: The integration ID to which this decoder belongs
                  example: "9e301671-382d-4c1a-9abf-3d9d9544789c"
                resource:
                  $ref: "#/components/schemas/DecoderResourceCreate"
            examples:
              create_decoder:
                summary: Example decoder creation
                value:
                  type: decoder
                  integration: "9e301671-382d-4c1a-9abf-3d9d9544789c"
                  resource:
                    name: "decoder/example/0"
                    enabled: true
                    metadata:
                      title: "Example Decoder"
                      description: "An example decoder for parsing logs"
                      author:
                        name: "Wazuh"
      responses:
        "201":
          description: Decoder created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /decoders/{decoder_id}:
    put:
      tags: [Decoders]
      summary: Update Decoder
      description: |
        Updates an existing decoder in the draft space. The decoder is validated against the Wazuh engine before being stored.
        The decoder ID in the path must match the resource ID in the payload (if provided).
      operationId: updateDecoder
      parameters:
        - $ref: "#/components/parameters/DecoderId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - type
                - resource
              properties:
                type:
                  type: string
                  enum: [decoder]
                  example: decoder
                resource:
                  $ref: "#/components/schemas/DecoderResource"
            examples:
              update_decoder:
                summary: Example decoder update
                value:
                  type: decoder
                  resource:
                    name: "decoder/example/0"
                    enabled: false
                    metadata:
                      title: "Updated Example Decoder"
                      description: "Updated decoder description"
                      author:
                        name: "Wazuh"
      responses:
        "200":
          description: Decoder updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [Decoders]
      summary: Delete Decoder
      description: |
        Deletes a decoder from the draft space. The decoder is also removed from any integrations that reference it.
      operationId: deleteDecoder
      parameters:
        - $ref: "#/components/parameters/DecoderId"
      responses:
        "200":
          $ref: "#/components/responses/ResourceDeleted"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Rule management endpoints
  /rules:
    post:
      tags: [Rules]
      summary: Create Rule
      description: |
        Creates a rule in the draft space. The server generates the UUID.
        The rule is validated against the Wazuh engine before being stored.
        Payload is identical to POST /_plugins/_security_analytics/rules.
      operationId: createRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RuleResource"
      responses:
        "201":
          description: Rule created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /rules/{rule_id}:
    put:
      tags: [Rules]
      summary: Update Rule
      description: |
        Updates an existing rule in the draft space and returns its identifier.
        The rule is validated against the Wazuh engine before being stored.
      operationId: updateRule
      parameters:
        - $ref: "#/components/parameters/RuleId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RuleResource"
      responses:
        "200":
          description: Rule updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [Rules]
      summary: Delete Rule
      description: |
        Deletes a rule from the draft space. The rule is also removed from any integrations that reference it.
      operationId: deleteRule
      parameters:
        - $ref: "#/components/parameters/RuleId"
      responses:
        "200":
          $ref: "#/components/responses/ResourceDeleted"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Integration metadata management endpoints
  /integrations:
    post:
      tags: [Integrations]
      summary: Create Integration
      description: |
        Creates a new integration in the draft space. The server generates the UUID for the integration.
        The integration is validated against the Wazuh engine before being stored.
        
        **Required fields in resource:**
        - `author` - Integration author name
        - `category` - Integration category
        - `decoders` - Array of decoder definitions
        - `description` - Integration description
        - `documentation` - Documentation URL or text
        - `kvdbs` - Array of KVDB references
        - `references` - Array of reference URLs
        - `rules` - Array of rule references
        - `title` - Integration title
        
        **Note:** The `id` field must NOT be included in the request body; it is auto-generated by the server.
      operationId: createIntegration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IntegrationCreateRequest"
            examples:
              create_integration:
                summary: Example integration creation
                value:
                  type: integration
                  resource:
                    author: "Wazuh"
                    category: "syslog"
                    title: "Apache HTTP Server Integration"
                    description: "Integration for Apache HTTP Server access and error logs"
                    documentation: "https://documentation.wazuh.com/integrations/apache"
                    decoders: []
                    kvdbs: []
                    rules: []
                    references:
                      - "https://httpd.apache.org/docs/current/logs.html"
      responses:
        "201":
          description: Integration created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
              examples:
                created:
                  summary: Integration created successfully
                  value:
                    id: "9e301671-382d-4c1a-9abf-3d9d9544789c"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /integrations/{integration_id}:
    put:
      tags: [Integrations]
      summary: Update Integration
      description: |
        Updates an existing integration in the draft space. The integration is validated against the Wazuh engine before being stored.
        Only integrations in the 'draft' space can be updated.
        
        **Required fields in resource:**
        - `author` - Integration author name
        - `category` - Integration category
        - `decoders` - Array of decoder definitions
        - `description` - Integration description
        - `documentation` - Documentation URL or text
        - `kvdbs` - Array of KVDB references
        - `references` - Array of reference URLs
        - `rules` - Array of rule references
        - `title` - Integration title
        
        **Note:** The `id` field must NOT be included in the request body; the ID is taken from the URL path parameter.
        The integration ID in the URL must be prefixed with `d_` (e.g., `d_9e301671-382d-4c1a-9abf-3d9d9544789c`).
      operationId: updateIntegration
      parameters:
        - $ref: "#/components/parameters/IntegrationId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IntegrationUpdateRequest"
            examples:
              update_integration:
                summary: Example integration update
                value:
                  type: integration
                  resource:
                    author: "Wazuh"
                    category: "syslog"
                    title: "Apache HTTP Server Integration (Updated)"
                    description: "Updated integration for Apache HTTP Server access and error logs"
                    documentation: "https://documentation.wazuh.com/integrations/apache"
                    enabled: false
                    decoders: []
                    kvdbs: []
                    rules: []
                    references:
                      - "https://httpd.apache.org/docs/current/logs.html"
                      - "https://httpd.apache.org/docs/current/mod/mod_log_config.html"
      responses:
        "200":
          description: Integration updated successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
              examples:
                updated:
                  summary: Integration updated successfully
                  value:
                    id: "9e301671-382d-4c1a-9abf-3d9d9544789c"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

    delete:
      tags: [Integrations]
      summary: Delete Integration
      description: |
        Deletes an existing integration from the draft space.
        Only integrations in the 'draft' space can be deleted.
        
        This operation will:
        - Remove the integration from the Security Analytics Plugin
        - Delete the integration from the CTI integrations index
        - Recalculate the space hash for the draft policy
        
        **Note:** The integration ID in the URL must be prefixed with `d_` (e.g., `d_9e301671-382d-4c1a-9abf-3d9d9544789c`).
      operationId: deleteIntegration
      parameters:
        - $ref: "#/components/parameters/IntegrationId"
      responses:
        "200":
          description: Integration deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ResourceResponse"
              examples:
                deleted:
                  summary: Integration deleted successfully
                  value:
                    id: "9e301671-382d-4c1a-9abf-3d9d9544789c"
        "400":
          $ref: "#/components/responses/BadRequest"
        "404":
          $ref: "#/components/responses/NotFound"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Logtest execution endpoint
  /logtest:
    post:
      tags: [Logtest]
      summary: Execute logtest
      operationId: executeLogtest
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/LogtestRequest"
      responses:
        "200":
          $ref: "#/components/responses/LogtestResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  # Promotion endpoints: move content from draft/test into next space
  /promote:
    get:
      tags: [Promotion]
      summary: Preview promotion differences
      description: |
        Calculates the differences between the current space and the next space in the promotion chain.
        Returns a list of operations (add, update, remove) that would be performed during promotion.
      operationId: promotePreview
      parameters:
        - name: space
          in: query
          required: true
          schema:
            type: string
            enum: [draft, test]
      responses:
        "200":
          $ref: "#/components/responses/PromotionPreviewResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

    post:
      tags: [Promotion]
      summary: Execute promotion
      description: |
        Executes the promotion of content from the source space to the target space based on the
        provided changes.
      operationId: promote
      requestBody:
        required: true
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/PolicyDiff"
                - $ref: "#/components/schemas/PromotionSpace"

      responses:
        "200":
          description: Promotion executed successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RestResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /policy:
    put:
      tags: [Draft Policy]
      summary: Update full draft policy
      operationId: policy_update
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Policy"
      responses:
        "200":
          description: Policy updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/RestResponse"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  # Shared path parameters for resource identifiers (UUIDs)
  parameters:
    KvdbId:
      name: kvdb_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    DecoderId:
      name: decoder_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    RuleId:
      name: rule_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    IntegrationId:
      name: integration_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  # --- Data Schemas ---
  schemas:
    SubscriptionPostRequest:
      type: object
      description: Input parameters for registering a CTI subscription.
      properties:
        device_code:
          type: string
          description: The device code for registration.
          example: "GmRhmhcxhwAzkoEqiMEg_DnyEysNkuNhszIySk9eS"
        client_id:
          type: string
          description: The client ID.
          example: "a17c21ed"
        expires_in:
          type: integer
          description: Expiration time in seconds.
          example: 1800
        interval:
          type: integer
          description: Polling interval in seconds.
          example: 5
      required:
        - device_code
        - client_id
        - expires_in
        - interval

    SubscriptionGetResponse:
      type: object
      description: Response schema for retrieving CTI credentials.
      properties:
        access_token:
          type: string
          description: Access token for authentication.
          example: "AYjcyMzY3ZDhiNmJkNTY"
        token_type:
          type: string
          description: Type of the token.
          example: "Bearer"
      required:
        - access_token
        - token_type

    # Request body for logtest execution
    LogtestRequest:
      type: object
      additionalProperties: false
      required:
        - queue
        - location
        - event
      properties:
        queue:
          type: integer
          minimum: 0
          description: Queue number used for logtest execution
          example: 1

        location:
          type: string
          description: Log file path or logical source location
          example: "/var/log/auth.log"

        agent_metadata:
          type: object
          additionalProperties: true
          description: Optional agent metadata passed to the logtest engine
          example: {}

        event:
          type: string
          description: Raw log event to be tested
          example: "Dec 19 12:00:00 host sshd[123]: Failed password for root from 10.0.0.1 port 12345 ssh2"

        trace_level:
          type: string
          enum:
            - NONE
            - BASIC
            - FULL
          description: Trace verbosity level
          example: "NONE"

    # Response body showing differences during promotion preview
    PolicyDiff:
      type: object
      properties:
        changes:
          type: object
          properties:
            policy:
              type: array
              items:
                $ref: "#/components/schemas/PromotionDiffItem"
            integrations:
              type: array
              items:
                $ref: "#/components/schemas/PromotionDiffItem"
            kvdbs:
              type: array
              items:
                $ref: "#/components/schemas/PromotionDiffItem"
            decoders:
              type: array
              items:
                $ref: "#/components/schemas/PromotionDiffItem"
            filters:
              type: array
              items:
                $ref: "#/components/schemas/PromotionDiffItem"

    PromotionDiffItem:
      type: object
      additionalProperties: false
      required:
        - id
        - operation
      properties:
        id:
          type: string
          description: Resource identifier (UUID)
          example: "m98uk4kBlb9cbROIpEj2"
        operation:
          type: string
          description: Operation to be performed (add, update, remove)
          enum: [add, update, remove]
          example: "update"

    # Request body to execute promotion from a given space with full policy
    PromotionSpace:
      type: object
      properties:
        space:
          type: string
          description: The source space to promote from.
          enum: [draft, test]
          example: draft

    # Integration document schema (metadata + references to related content)
    IntegrationResource:
      type: object
      additionalProperties: false
      description: Integration resource schema with all fields
      required:
        - author
        - category
        - decoders
        - description
        - documentation
        - kvdbs
        - references
        - rules
        - title
      properties:
        id:
          type: string
          format: uuid
          description: Integration UUID (auto-generated on create, taken from URL on update)

        title:
          type: string
          description: Integration title
          example: "Apache HTTP Server Integration"

        description:
          type: string
          description: Integration description
          example: "Integration for Apache HTTP Server access and error logs"

        author:
          type: string
          description: Integration author name
          example: "Wazuh"

        category:
          type: string
          description: Integration category
          example: "syslog"

        date:
          type: string
          format: date-time
          description: Creation or last update date (auto-generated by the server)

        documentation:
          type: string
          description: Documentation URL or text
          example: "https://documentation.wazuh.com/integrations/apache"

        enabled:
          type: boolean
          description: Whether the integration is enabled (defaults to true if not provided)
          example: true

        parent_decoder:
          type: string
          format: uuid
          description: Parent decoder UUID

        decoders:
          type: array
          items:
            type: object
            additionalProperties: true
          description: Array of decoder definitions for this integration
          example:
            - name: "decoder/apache-access/0"
              enabled: true
              metadata:
                title: "Apache Access Log Decoder"
                description: "Parses Apache HTTP Server access logs"
                author:
                  name: "Wazuh"

        kvdbs:
          type: array
          items:
            type: string
          description: Array of KVDB references
          example: []

        rules:
          type: array
          items:
            type: string
          description: Array of rule references
          example:
            - "rule/apache-suspicious-request/0"

        references:
          type: array
          items:
            type: string
          description: Array of reference URLs
          example:
            - "https://httpd.apache.org/docs/current/logs.html"

        metadata:
          type: object
          additionalProperties: false
          properties:
            author:
              type: object
              additionalProperties: false
              properties:
                modified:
                  type: string
                  format: date-time

    # Request schema for creating an integration (POST)
    IntegrationCreateRequest:
      type: object
      additionalProperties: false
      description: |
        Request body for creating a new integration.
        The `id` field must NOT be included; it is auto-generated by the server.
      required:
        - type
        - resource
      properties:
        type:
          type: string
          enum: [integration]
          description: Resource type (must be 'integration')
          example: integration
        resource:
          $ref: "#/components/schemas/IntegrationResource"

    # Request schema for updating an integration (PUT)
    IntegrationUpdateRequest:
      type: object
      additionalProperties: false
      description: |
        Request body for updating an existing integration.
        The `id` field must NOT be included in the resource; the ID is taken from the URL path parameter.
      required:
        - type
        - resource
      properties:
        type:
          type: string
          enum: [integration]
          description: Resource type (must be 'integration')
          example: integration
        resource:
          $ref: "#/components/schemas/IntegrationResource"

    # Decoder document schema for creation (id is auto-generated)
    DecoderResourceCreate:
      type: object
      additionalProperties: false
      required:
        - name
        - enabled
        - metadata
      properties:
        name:
          type: string
          description: Decoder name identifier
          example: "decoder/example/0"

        enabled:
          type: boolean
          description: Whether the decoder is enabled

        parents:
          type: array
          items:
            type: string
            format: uuid
          description: Parent decoder UUIDs

        definitions:
          type: array
          items:
            type: object
            additionalProperties: true
          description: Decoder definitions (engine-specific)

        normalize:
          type: object
          additionalProperties: true
          description: Normalization rules (engine-specific)

        check:
          type: object
          additionalProperties: true
          description: Decoder check logic (engine-specific)

        metadata:
          type: object
          additionalProperties: false
          required:
            - title
            - description
            - author
          properties:
            title:
              type: string
              description: Human-readable decoder title
              example: "Example Decoder"

            description:
              type: string
              description: Decoder description
              example: "An example decoder for parsing logs"

            module:
              type: string
              description: Module name

            compatibility:
              type: array
              items:
                type: string
              description: Compatibility versions

            references:
              type: array
              items:
                type: string
                format: uri
              description: Reference URLs

            versions:
              type: array
              items:
                type: string
              description: Version numbers

            author:
              type: object
              additionalProperties: false
              required:
                - name
              properties:
                name:
                  type: string
                  example: "Wazuh"
                email:
                  type: string
                  format: email
                url:
                  type: string
                  format: uri
                date:
                  type: string
                  format: date-time
                modified:
                  type: string
                  format: date-time

    # Decoder document schema (engine-specific definitions and metadata)
    DecoderResource:
      type: object
      additionalProperties: false
      required:
        - id
        - name
        - enabled
        - metadata
      properties:
        id:
          type: string
          format: uuid
          description: Decoder UUID (auto-generated on create, required on update)

        name:
          type: string
          description: Decoder name identifier
          example: "decoder/example/0"

        enabled:
          type: boolean
          description: Whether the decoder is enabled

        parents:
          type: array
          items:
            type: string
            format: uuid
          description: Parent decoder UUIDs

        definitions:
          type: array
          items:
            type: object
            additionalProperties: true
          description: Decoder definitions (engine-specific)

        normalize:
          type: object
          additionalProperties: true
          description: Normalization rules (engine-specific)

        check:
          type: object
          additionalProperties: true
          description: Decoder check logic (engine-specific)

        metadata:
          type: object
          additionalProperties: false
          required:
            - title
            - description
            - author
          properties:
            title:
              type: string
              description: Human-readable decoder title
              example: "Example Decoder"

            description:
              type: string
              description: Decoder description
              example: "An example decoder for parsing logs"

            module:
              type: string
              description: Module name

            compatibility:
              type: array
              items:
                type: string
              description: Compatibility versions

            references:
              type: array
              items:
                type: string
                format: uri
              description: Reference URLs

            versions:
              type: array
              items:
                type: string
              description: Version numbers

            author:
              type: object
              additionalProperties: false
              required:
                - name
              properties:
                name:
                  type: string
                  example: "Wazuh"
                email:
                  type: string
                  format: email
                url:
                  type: string
                  format: uri
                date:
                  type: string
                  format: date-time
                modified:
                  type: string
                  format: date-time

    # KVDB document schema (key-value data managed by the engine)
    KvdbResource:
      type: object
      additionalProperties: false
      required:
        - id
        - title
        - enabled
      properties:
        id:
          type: string
          format: uuid

        title:
          type: string

        description:
          type: string

        author:
          type: string

        date:
          type: string
          format: date-time

        documentation:
          type: string

        enabled:
          type: boolean

        content:
          type: object
          additionalProperties: true
          description: KVDB key-value content (engine-managed)

        references:
          type: array
          items:
            type: string

        metadata:
          type: object
          additionalProperties: false
          properties:
            author:
              type: object
              additionalProperties: false
              properties:
                modified:
                  type: string
                  format: date-time

    # Rule document schema (Sigma-like)
    RuleResource:
      type: object
      additionalProperties: false
      required:
        - id
        - name
        - title
        - enabled
        - detection
        - logsource
      properties:
        id:
          type: string
          format: uuid

        sigma_id:
          type: string

        name:
          type: string

        title:
          type: string

        description:
          type: string

        author:
          type: string

        date:
          type: string
          format: date

        modified:
          type: string
          format: date

        enabled:
          type: boolean

        status:
          type: string

        level:
          type: string

        license:
          type: string

        scope:
          type: string

        tags:
          type: array
          items:
            type: string

        fields:
          type: array
          items:
            type: string

        falsepositives:
          type: array
          items:
            type: string

        references:
          type: array
          items:
            type: string

        detection:
          type: object
          additionalProperties: true
          required:
            - condition
          properties:
            condition:
              type: string

        logsource:
          type: object
          additionalProperties: false
          properties:
            category:
              type: string
            product:
              type: string
            service:
              type: string
            definition:
              type: string

        related:
          type: array
          items:
            type: object
            additionalProperties: false
            required:
              - id
              - type
            properties:
              id:
                type: string
              type:
                type: string

        taxonomy:
          type: object
          additionalProperties: true

    # Policy Resource
    Policy:
      type: object
      additionalProperties: false
      required:
        - type
        - root_decoder
        - integrations
      properties:
        type:
          type: string
          enum: [policy]
          description: Resource type identifier
          example: "policy"

        root_decoder:
          type: string
          description: Reference to the root decoder asset
          example: "decoder/integrations/0"

        integrations:
          type: array
          items:
            type: string
          description: List of integration asset references
          example: ["integration/wazuh-core/0"]

        enrichments:
          type: array
          items:
            type: string
            enum: [file, domain-name, ip, url, geo]
          description: List of enrichment types to apply. Allowed values are file, domain-name, ip, url, geo. No duplicates allowed.
          example: ["file", "ip", "geo"]

        author:
          type: string
          description: Author of the policy
          example: "Wazuh Inc."

        description:
          type: string
          description: Brief description of the policy
          example: "Policy description"

        documentation:
          type: string
          description: Detailed documentation for the policy
          example: "Detailed documentation"

        references:
          type: string
          description: External references or links
          example: "External references"

    # Standard resource creation/update response containing the generated UUID
    ResourceResponse:
      type: object
      description: Resource creation or update result
      required:
        - id
      properties:
        id:
          type: string
          format: uuid

    RestResponse:
      type: object
      description: Standard response schema.
      properties:
        message:
          type: string
        status:
          type: integer
      required:
        - message
        - status

    RestErrorResponse:
      type: object
      description: Standard error response schema.
      properties:
        status:
          type: string
        message:
          type: string

  # --- Responses schemas ---
  responses:
    # --- Success Responses ---
    SubscriptionCreated:
      description: Created - Subscription registered successfully.

    GetCredentialsSuccess:
      description: OK - Credentials retrieved successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/SubscriptionGetResponse"
          examples:
            credentials:
              summary: Valid credentials response
              value:
                access_token: "AYjcyMzY3ZDhiNmJkNTY"
                token_type: "Bearer"

    SubscriptionDeleted:
      description: OK - Subscription deleted successfully.

    UpdateAccepted:
      description: Accepted - The update request has been accepted for processing.
      headers:
        X-RateLimit-Limit:
          description: The maximum number of requests allowed per hour.
          schema:
            type: integer
            example: 10
        X-RateLimit-Remaining:
          description: The number of requests remaining in the current window.
          schema:
            type: integer
            example: 7
        X-RateLimit-Reset:
          description: The time at which the current rate limit window resets (Unix timestamp).
          schema:
            type: integer
            example: 1699963200

    # --- Error Responses ---
    BadRequest:
      description: |
        Bad Request - The request could not be processed due to invalid input.

        Common causes:
        - Missing required fields in the request body
        - Invalid field format (e.g., invalid UUID)
        - Invalid resource type
        - Engine validation failed (payload does not pass Wazuh Engine validation)
        - Resource not in draft space (only draft resources can be modified)
        - Resource has dependent resources that must be deleted first
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestErrorResponse"
          examples:
            missing_field:
              summary: Missing required field
              value:
                message: "Missing [id] field."
                status: 400
            invalid_body:
              summary: Invalid request body
              value:
                message: "Invalid request body"
                status: 400
            invalid_uuid:
              summary: Invalid UUID format
              value:
                message: "'invalid-id' is not a valid UUID"
                status: 400
            not_in_draft:
              summary: Resource not in draft space
              value:
                message: "Integration [9e301671-382d-4c1a-9abf-3d9d9544789c] is not in draft space"
                status: 400
            has_dependencies:
              summary: Resource has dependent resources
              value:
                message: "Cannot delete integration because it has decoders attached"
                status: 400

    Unauthorized:
      description: Unauthorized - Authentication failed or credentials are invalid.

    ResourceDeleted:
      description: OK - Resource deleted successfully.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestResponse"
          examples:
            resource_deleted:
              summary: Resource deletion confirmation
              value:
                _id: "m98uk4kBlb9cbROIpEj2"
                status: "success"

    NotFound:
      description: Not Found - The requested resource does not exist.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestErrorResponse"
          examples:
            resource_not_found:
              summary: Resource not found
              value:
                message: "Resource not found"
                status: 404

    Conflict:
      description: Conflict - Undergoing content update.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestErrorResponse"
          examples:
            undergoing_update:
              summary: Content update in progress
              value:
                error: "A content update is already in progress."

    TooManyRequests:
      description: Too Many Requests - Rate limit exceeded.
      headers:
        X-RateLimit-Limit:
          description: The maximum number of requests allowed per hour.
          schema:
            type: integer
            example: 10
        X-RateLimit-Remaining:
          description: The number of requests remaining (will be 0).
          schema:
            type: integer
            example: 0
        X-RateLimit-Reset:
          description: The time at which the current rate limit window resets (Unix timestamp).
          schema:
            type: integer
            example: 1699963200
        Retry-After:
          description: Number of seconds to wait before retrying.
          schema:
            type: integer
            example: 3600
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestErrorResponse"
          examples:
            rate_limit_exceeded:
              summary: Rate limit exceeded
              value:
                error: "Too many update requests. Please try again later."

    InternalServerError:
      description: |
        Internal Server Error - The server encountered an unexpected error.

        Common causes:
        - Engine service is unavailable
        - Security Analytics service is unavailable
        - Indexer operation failed
        - Unexpected exception during processing
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/RestErrorResponse"
          examples:
            internal_error:
              summary: Internal server error
              value:
                message: "Internal Server Error"
                status: 500

    # Response body for logtest execution results (pass-through)
    LogtestResponse:
      description: Logtest result
      content:
        application/json:
          schema:
            type: object
            additionalProperties: false
            properties:
              status:
                type: string
                example: "OK"
              result:
                type: object
                properties:
                  output:
                    type: string
                    example: '{"wazuh":{"protocol":{"queue":1,"location":"syscheck"},"integration":{"category":"Security","name":"integration/wazuh-core/0","decoders":["core-wazuh-message","integrations"]}},"name":"nahuel","event":{"original":"File /etc/passwd modified"},"@timestamp":"2025-12-26T17:33:22Z"}'
                  asset_traces:
                    type: array
                    items:
                      type: object
                      properties:
                        asset:
                          type: string
                          example: "decoder/core-wazuh-message/0"
                        success:
                          type: boolean
                          example: true
                        traces:
                          type: array
                          items:
                            type: string
                          example: ["@timestamp: get_date -> Success"]

    PromotionPreviewResponse:
      description: Promotion preview result
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/PolicyDiff"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication using JWT (JSON Web Token).
        Include the token in the Authorization header as: `Authorization: Bearer <token>`

        Tokens can be obtained through the Wazuh authentication system.
    basicAuth:
      type: http
      scheme: basic
      description: |
        **Secure Basic Authentication**.
        Clients must provide username and password encoded in Base64.
